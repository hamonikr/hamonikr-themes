#!/bin/bash

# USER privilege script

[ "$EUID" = 0 ] && echo "Run with user authority. (EUID : $EUID)" && exit
[ ! -d "/home/${USER}/.hamonikr/" ] && mkdir -p /home/${USER}/.hamonikr/
[ ! -d "/home/${USER}/.config/autostart/" ] && mkdir -p /home/${USER}/.config/autostart/

log() {
    # stdout
    echo "$@"
    # write to logfile
    mkdir -p $HOME/.hamonikr/log
    exec 3>&1 1>>$HOME/.hamonikr/log/${0##*/}.log 2>&1 && echo "$(date +%Y-%m-%d_%H:%M_%S) ${0##*/} : $@"
    # stdout reset
    exec 1>&3 3>&-
}

show_conky() {
  # Check if conky command exists
  if command -v conky &> /dev/null; then
    # conky - simple
    if [ -f "$HOME/.conky/paektu/simple.conf" ]; then
      is_conky_simple=$(ps -ef | grep "conky -c $HOME/.conky/paektu/simple.conf" | grep -v "grep" | awk 'FNR {print $2}')

      if [ "$is_conky_simple" = "" ]; then
          cd $HOME/.conky/paektu
          conky -c "$HOME/.conky/paektu/simple.conf" &
      else
          kill -9 $(ps -ef | grep "conky -c $HOME/.conky/paektu/simple.conf" | grep -v "grep" | awk 'FNR {print $2}')
          cd $HOME/.conky/paektu
          conky -c "$HOME/.conky/paektu/simple.conf" &      
      fi
    fi

    # conky - widget
    if [ -f "$HOME/.conky/paektu/widget.conf" ]; then
      is_conky_simple=$(ps -ef | grep "conky -c $HOME/.conky/paektu/widget.conf" | grep -v "grep" | awk 'FNR {print $2}')

      if [ "$is_conky_simple" = "" ]; then
          cd $HOME/.conky/paektu
          conky -c "$HOME/.conky/paektu/widget.conf" &
      else
          kill -9 $(ps -ef | grep "conky -c $HOME/.conky/paektu/widget.conf" | grep -v "grep" | awk 'FNR {print $2}')
          cd $HOME/.conky/paektu
          conky -c "$HOME/.conky/paektu/widget.conf" &      
      fi
    fi    
    
  else
    log "Conky command not found. Skipping conky configuration."
  fi
}

# 가상화 환경이 아니고 화면 가로 크기가 1920 이상인 경우에만 동작해야 함
# 가상화 환경을 확인하는 방법 : https://www.baeldung.com/linux/determine-virtualization-tech
# systemd-detect-virt 의 결과가 none 아니면 가상화 환경

# 가상화 환경 확인 및 해상도 체크 후 show_conky 실행
check_virtualization_and_resolution() {
  # Check if the system is virtualized
  if [[ "$(systemd-detect-virt)" != "none" ]]; then
    log "Virtualization detected. Skipping conky configuration."
    return 1
  fi

  # Check screen resolution width using xrandr
  screen_width=$(xrandr | grep '*' | awk '{print $1}' | awk -Fx '{print $1}' | sort -nr | head -n1)

  if [[ "$screen_width" -ge 1920 ]]; then
    log "Screen width is $screen_width, executing conky configuration."
    show_conky
  else
    log "Screen width is less than 1920, skipping conky configuration."
  fi
}

# Execute the function with error handling
(check_virtualization_and_resolution || true)
